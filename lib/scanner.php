<?php

require "tokenizer.php";
ini_set('memory_limit','128M');

class Scanner {
	
	
	public  function scan($files)
	{
		//var_dump($files);exit;

		foreach($files as $file)
		{
			if(is_dir($file) && !file_exists($file.'\\'.'patched'))
			{
				mkdir($file.'\\'.'patched');
			}
			else if(!is_dir($file))
			{
				$file = str_replace("/", "\\", $file);
				$loc = explode("\\", $file);
				$file_name = array_pop($loc);
				$loc = implode("\\", $loc);
				if(!file_exists($loc.'\\'.'patched'))
				{
					mkdir($loc.'\\'.'patched');
				}
				$fp = fopen($loc."\\"."patched\\".$file_name,"a");
				$this->file_scan($file,$fp);

			}
		}
	}
	public function file_scan($file,$fp)
	{
		$lines = file($file);
		
		foreach ($lines as $line) {
			if($id = strpos($line, " \$_GET["))
			{
				$next_id = strpos($line, "]",$id);
				$variable = substr($line, $id, $next_id-$id);
				$new_line = str_replace($variable, 'htmlspecialchars('.$variable.')', $line);
				fwrite($fp, $new_line);
				
			}  else if($id = strpos($line, " \$_POST[")) {
				$next_id = strpos($line, "]",$id);
				$variable = substr($line, $id, $next_id-$id+1);
				$new_line = str_replace($variable, 'htmlspecialchars('.$variable.')', $line);
				fwrite($fp, $new_line);
			} else{
				fwrite($fp,$line);
			}
		}
		//exit;
	}
}

?>